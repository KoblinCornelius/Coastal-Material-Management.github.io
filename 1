<!DOCTYPE html>
<html>
<head>
    <title>QR 코드 재고 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js"></script>
</head>
<body>
    <h1>QR 코드 재고 관리</h1>
    <form id="login-form">
        <input type="email" id="email" placeholder="이메일">
        <input type="password" id="password" placeholder="비밀번호">
        <button type="button" onclick="login()">로그인</button>
    </form>
    <div id="reader" style="width:300px;"></div>
    <input type="text" id="qr-text" placeholder="QR 코드에 넣을 텍스트를 입력하세요">
    <button onclick="generateQRCode()">QR 코드 생성</button>
    <div id="qrcode"></div>

    <script>
        // Firebase 설정
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // 로그인 기능
        function login() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("사용자 로그인됨: ", userCredential.user);
                })
                .catch((error) => {
                    console.error("로그인 오류: ", error);
                });
        }

        // QR 코드 생성 기능
        function generateQRCode() {
            var qrtext = document.getElementById("qr-text").value;
            var qr = qrcode(0, 'L');
            qr.addData(qrtext);
            qr.make();
            document.getElementById('qrcode').innerHTML = qr.createImgTag();
        }

        // QR 코드 스캔 성공 시 호출되는 함수
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`코드 매칭 = ${decodedText}`, decodedResult);
            saveQRCodeData(decodedText);
        }

        // QR 코드 스캔 실패 시 호출되는 함수
        function onScanFailure(error) {
            console.warn(`코드 스캔 오류 = ${error}`);
        }

        // QR 코드 스캔 기능 초기화
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);

        // QR 코드 데이터를 Firestore에 저장하는 함수
        function saveQRCodeData(data) {
            db.collection("qr-codes").add({
                data: data,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then((docRef) => {
                console.log("문서 작성됨 ID: ", docRef.id);
            })
            .catch((error) => {
                console.error("문서 추가 중 오류: ", error);
            });
        }
    </script>
</body>
</html>
