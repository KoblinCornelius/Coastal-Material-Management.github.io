<!DOCTYPE html>
<html>
<head>
    <title>QR 코드 재고 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js"></script>
</head>
<body>
    <h1>QR 코드 재고 관리</h1>
    <form id="login-form">
        <input type="email" id="email" placeholder="이메일">
        <input type="password" id="password" placeholder="비밀번호">
        <button type="button" onclick="login()">로그인</button>
    </form>
    <div id="reader" style="width:300px;"></div>
    <input type="text" id="qr-text" placeholder="QR 코드에 넣을 텍스트를 입력하세요">
    <button onclick="generateQRCode()">QR 코드 생성</button>
    <div id="qrcode"></div>
    <div>
        <h2>자재 추가</h2>
        <form id="material-form">
            <input type="text" id="material-name" placeholder="자재명" required>
            <input type="date" id="in-date" required>
            <input type="date" id="out-date" required>
            <input type="number" id="total-quantity" placeholder="총개수" required>
            <input type="number" id="required-quantity" placeholder="필요수량" required>
            <input type="text" id="location" placeholder="자재위치" required>
            <button type="button" onclick="addMaterial()">자재 추가</button>
        </form>
    </div>
    <div>
        <h2>자재 리스트</h2>
        <ul id="materials-list"></ul>
    </div>

    <script>
        // Firebase 설정
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // 로그인 기능
        function login() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("사용자 로그인됨: ", userCredential.user);
                    loadMaterials();
                })
                .catch((error) => {
                    console.error("로그인 오류: ", error);
                });
        }

        // QR 코드 생성 기능
        function generateQRCode() {
            var qrtext = document.getElementById("qr-text").value;
            var qr = qrcode(0, 'L');
            qr.addData(qrtext);
            qr.make();
            document.getElementById('qrcode').innerHTML = qr.createImgTag();
        }

        // QR 코드 스캔 성공 시 호출되는 함수
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`코드 매칭 = ${decodedText}`, decodedResult);
            saveQRCodeData(decodedText);
        }

        // QR 코드 스캔 실패 시 호출되는 함수
        function onScanFailure(error) {
            console.warn(`코드 스캔 오류 = ${error}`);
        }

        // QR 코드 스캔 기능 초기화
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);

        // QR 코드 데이터를 Firestore에 저장하는 함수
        function saveQRCodeData(data) {
            var type = prompt("입고인지 출고인지 입력하세요 (in/out):").toLowerCase();
            db.collection(type === "in" ? "in-logs" : "out-logs").add({
                data: data,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then((docRef) => {
                console.log("문서 작성됨 ID: ", docRef.id);
                loadMaterials();
            })
            .catch((error) => {
                console.error("문서 추가 중 오류: ", error);
            });
        }

        // 자재를 Firestore에 저장하는 함수
        function addMaterial() {
            var materialName = document.getElementById("material-name").value;
            var inDate = document.getElementById("in-date").value;
            var outDate = document.getElementById("out-date").value;
            var totalQuantity = document.getElementById("total-quantity").value;
            var requiredQuantity = document.getElementById("required-quantity").value;
            var location = document.getElementById("location").value;

            db.collection("materials").add({
                materialName: materialName,
                inDate: inDate,
                outDate: outDate,
                totalQuantity: totalQuantity,
                requiredQuantity: requiredQuantity,
                location: location,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then((docRef) => {
                console.log("자재 추가됨 ID: ", docRef.id);
                loadMaterials();
            })
            .catch((error) => {
                console.error("자재 추가 중 오류: ", error);
            });
        }

        // Firestore에서 자재 리스트를 불러오는 함수
        function loadMaterials() {
            db.collection("materials").orderBy("timestamp", "desc").get().then((querySnapshot) => {
                var materialsList = document.getElementById("materials-list");
                materialsList.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    var data = doc.data();
                    var li = document.createElement("li");
                    li.textContent = `자재명: ${data.materialName}, 입고일: ${data.inDate}, 출고일: ${data.outDate}, 총개수: ${data.totalQuantity}, 필요수량: ${data.requiredQuantity}, 자재위치: ${data.location}`;
                    materialsList.appendChild(li);
                });
            });
        }
    </script>
</body>
</html>
